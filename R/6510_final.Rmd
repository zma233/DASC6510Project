---
title: "6510_final"
author: "Zijun Ma_T00711782"
date: "2023-11-30"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load the packages
library(fpp3)
library(zoo)
library(tseries)
library(quantmod) # download data form Yahoo finance
library(moments) # to know summary statistics of data
library(knitr)
library(forecast)
library(fabletools)
library(fable.prophet)
library(prophet)
library(ggplot2)
```


# Import data


```{r}
df <- read.csv("/Users/zijunma/Desktop/6510final/DailyDelhiClimateFull.csv")
```


```{r}
# 创建箱线图
ggplot(df, aes_string(y = "meantemp")) +
  geom_boxplot(fill = "skyblue", color = "black") +
  labs(title = paste("Boxplot of meantemp")) +
  theme_minimal()
plot(df$meantemp)
# boxplot(df$humidity)

ggplot(df, aes_string(y = "humidity")) +
  geom_boxplot(fill = "skyblue", color = "black") +
  labs(title = paste("Boxplot of humidity")) +
  theme_minimal()
plot(df$humidity)

ggplot(df, aes_string(y = "wind_speed")) +
  geom_boxplot(fill = "skyblue", color = "black") +
  labs(title = paste("Boxplot of wind_speed")) +
  theme_minimal()
plot(df$wind_speed)

ggplot(df, aes_string(y = "meanpressure")) +
  geom_boxplot(fill = "skyblue", color = "black") +
  labs(title = paste("Boxplot of meanpressure")) +
  theme_minimal()
plot(df$meanpressure)
```

```{r}
# # 选择你要处理的列
# 
# column_data <- df$wind_speed
# 
# # 计算四分位数
# Q1 <- quantile(column_data, 0.25)
# Q3 <- quantile(column_data, 0.75)
# 
# # 计算IQR（四分位数间距）
# IQR <- Q3 - Q1
# 
# # 计算离群值的上下界
# lower_bound <- Q1 - 1.5 * IQR
# upper_bound <- Q3 + 1.5 * IQR
# 
# # 去除离群值
# column_no_outliers <- column_data[column_data >= lower_bound & column_data <= upper_bound]
# 
# outliers_row <- which(df$wind_speed <= lower_bound | df$wind_speed >= upper_bound)
# 
# # 创建箱线图显示处理前后的差异
# boxplot(column_data, main = "With Outliers", col = "skyblue", border = "black")
# boxplot(column_no_outliers, main = "Without Outliers", col = "skyblue", border = "black")
#
```


```{r}
check_outliers <- function(column_data) {
  # 计算四分位数
  Q1 <- quantile(column_data, 0.05)
  Q3 <- quantile(column_data, 0.95)

  # 计算IQR（四分位数间距）
  IQR <- Q3 - Q1
  
  # 计算离群值的上下界
  lower_bound <- Q1 - 1.5 * IQR
  upper_bound <- Q3 + 1.5 * IQR
    
  # 去除离群值
  column_no_outliers <- column_data[column_data >= lower_bound & column_data <=
                                      upper_bound]
  
  outliers_row <- which(column_data <= lower_bound | column_data >= upper_bound)
  
  return(outliers_row)
  # # 创建箱线图显示处理前后的差异
  # boxplot(column_data, main = "With Outliers", col = "skyblue", border = "black")
  # boxplot(column_no_outliers, main = "Without Outliers", col = "skyblue", border = "black")
}

```

```{r}
# check missing data
# if (any(df$meantemp == 0)) {
#   print("has zero value")
# } else {
#   print("no zero value")
# }
# 
# if (any(df$humidity == 0)) {
#   print("has zero value")
# } else {
#   print("no zero value")
# }
# 
# if (any(df$wind_speed == 0)) {
#   print("has zero value")
# } else {
#   print("no zero value")
# }
# 
# if (any(df$meanpressure <= 0)) {
#   print("has outlier value")
# } else {
#   print("no outlier value")
# }

# outliers_row <- which(df$meanpressure <= 0)
# zero_rows <- which(df$wind_speed == 0)
```


```{r}
meantemp_outliers_row <- check_outliers(df$meantemp)
humidity_outliers_row <- check_outliers(df$humidity)
wind_speed_outliers_row <- check_outliers(df$wind_speed)
meanpressure_outliers_row <- check_outliers(df$meanpressure)


df <- df[-check_outliers(df$wind_speed), ]
df <- df[-check_outliers(df$meanpressure), ]

```

```{r}
full_data_tsibble <- df |>
  mutate(date = as.Date(date)) |>
  as_tsibble(index = date, regular = TRUE) |>
  mutate(day = row_number()) |>
  update_tsibble(index = day, regular = TRUE)
```

```{r}
# split the dataset into training dataset and testing dataset
train_data <- full_data_tsibble |>
  filter(date >= as.Date("2013-01-01") & date <= as.Date("2016-12-31"))

test_data <- full_data_tsibble |>
  filter(date >= as.Date("2017-01-01") & date <= as.Date("2017-04-24"))
```

## standard regression model
```{r}
# Fit a regression model with standard time series regression model
regression_fit_model <- train_data |>
  model(
    TSLM(meantemp ~ humidity + wind_speed + meanpressure)
  )

report(regression_fit_model)

# Forecast using regression model on the test set
forecast_regression_model <- regression_fit_model |>
  forecast(new_data = test_data)

# Plot regression forecasts
forecast_regression_model |>
  autoplot(full_data_tsibble) +
  labs(title = "Regression Model Forecast for Daily Delhi Climate Data")

# accuracy
forecast_regression_model.acc <- accuracy(forecast_regression_model$.mean, test_data$meantemp)
forecast_regression_model.acc

# check residual plot
regression_fit_model |> gg_tsresiduals()

# check error term

augment(regression_fit_model) |>
  features(.innov, ljung_box, lag = 10)
```
p-value is 0, can reject the null hypothesis, it shows the error term does not follow the white noise behavior.

## dynamic regression model
```{r}
# Fit a regression model with the SARIMA errors process
dynamic_reg_fit_model <- train_data |>
  model(ARIMA(meantemp ~ humidity + wind_speed + meanpressure)
        )

report(dynamic_reg_fit_model)

# Forecast using dynamic regression model on the test set
forecast_dynamic_reg_model <- dynamic_reg_fit_model |>
  forecast(new_data = test_data)

# Plot dynamic regression forecasts
forecast_dynamic_reg_model |>
  autoplot(full_data_tsibble) +
  labs(title = "Dynamic Regression Model Forecast for Daily Delhi Climate Data") 

forecast_dynamic_reg_model.acc <- accuracy(forecast_dynamic_reg_model$.mean, test_data$meantemp)

forecast_dynamic_reg_model.acc

# check residual plot
dynamic_reg_fit_model |> gg_tsresiduals()

augment(dynamic_reg_fit_model) |>
  features(.innov, ljung_box, dof = 4, lag = 8)
```
The p-value is 0.885, which is larger than 0.05, thus we cannot reject null hypothesis, and it shows the error term which follow ARIMA(1,1,3) model has white noise behavior.

From the residual plot of the fitted dynamic regression model, we can see there is barely heteroscedasticity in the residuals. The model also has few significant autocorrelation in the residuals, and the histogram of the residuals shows normal distribution. It shows ARIMA errors follow the white noise behavior very closely.

Thus, we can indicate that dynamic regression model somehow adequately addressed the autocorrelations seen in the standard time series regression model, because the SARIMA error term in dynamic regression model capture these information which does not explain in the standard regression time series model.

## NNAR model
```{r}
## NNAR model
NNAR_fit <- train_data |>
  model(NNETAR(meantemp))

NNAR_fc <- NNAR_fit |>
  forecast(new_data = test_data)

# View(NNAR_fc)
accuracy_NNAR <- fabletools::accuracy(NNAR_fc, full_data_tsibble)
accuracy_NNAR

NNAR_fit |> gg_tsresiduals()
```

## Prophet model
```{r}
## Prophet model
# meantemp <- df[,2]
# N <- nrow(full_data_tsibble)
# 
# n <- nrow(test_data) # test sample size

a <- train_data$meantemp
b <- test_data$meantemp

train <- as.data.frame(a)
train <- cbind(ds = train_data$date, train)
rownames(train) <- 1:nrow(train)
colnames(train) <- c ("ds", "y")
head(train)

test <- as.data.frame(b)
test <- cbind(ds = test_data$date, test)
rownames(test) <- 1:nrow(test)
colnames(test) <- c ("ds", "y")
head(test)

# fit the prophet model
fit.prophet <- prophet(train)
future <- data.frame(ds = test_data$date)
fit.prophet_fc <- predict(fit.prophet, future)

plot(fit.prophet, fit.prophet_fc)

## prophet decomposition
prophet_plot_components(fit.prophet, fit.prophet_fc)

# accuracy
accuracy_fit_prophet <- forecast::accuracy(fit.prophet_fc$yhat, test_data$meantemp)
accuracy_fit_prophet

```


```{r}
bench_fit <- train_data |>
  model(
    naive = NAIVE(meantemp)
    )

bench_fc <- bench_fit |>
  forecast(test_data)

fabletools::accuracy(bench_fc, full_data_tsibble)

```



